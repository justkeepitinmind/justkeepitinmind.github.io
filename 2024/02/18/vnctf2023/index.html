
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>vnctf2023 | shizuku&#39;s home</title>
  <meta name="author" content="shizuku" />
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <link rel="icon" href="/images/setumi.jpg" />
  <link rel="preconnect" href="https://cdn.staticfile.org" />
<script src="https://cdn.staticfile.org/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.loli.net" />
<link rel="preconnect" href="https://gstatic.loli.net" crossorigin />
<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap" />
<script>
  const mixins = {};
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.org/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.org/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/11.9.0/styles/github.min.css" />
<script src="/js/lib/highlight.js"></script>


<script src="https://cdn.staticfile.org/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdn.staticfile.org/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />


<canvas id="fireworks" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"></canvas>
<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>
<script src="/js/lib/fireworks.min.js"></script>

<!--
<canvas id="background" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1"></canvas>
<script src="/js/lib/background.min.js"></script>
-->
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="shizuku's home" type="application/atom+xml">
</head>

<body>
  <div id="layout">
    <transition name="fade">
      <div id="loading" v-show="loading">
        <div id="loading-circle">
          <h2>LOADING</h2>
          <p>加载过慢请开启缓存 浏览器默认开启</p>
          <img src="/images/loading.gif" />
        </div>
      </div>
    </transition>
    <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>SHIZUKU&#39;S HOME</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/friendLinks">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Friend Links</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;SHIZUKU&#39;S HOME</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
                <a href="/friendLinks">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-link fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Friend Links</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

    <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
      <div class="article">
    <div>
        <h1>vnctf2023</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/2/18
        </span>
        
        <span class="category">
            <a href="/categories/write-up/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                write up
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/crypto/" style="color: #00bcd4">crypto</a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="basiccry"><a href="#basiccry" class="headerlink" title="basiccry"></a>basiccry</h2><h3 id="题意"><a href="#题意" class="headerlink" title="题意"></a>题意</h3><pre><code class="python">import random 
from Crypto.Util.number import *
flag = b&#39;********************************&#39;
m = bytes_to_long(flag)

rr = matrix(ZZ,[random_vector(ZZ,256,0,2) for _ in range(256)])
mm = matrix(GF(2),[list(bin(m)[2:].rjust(256,&#39;0&#39;))]*256)
cc = mm+rr
ii = vector(ZZ,input(&quot;Undoubtedly, this is a backdoor left for you: &quot;).split(&quot;,&quot;))
dd = rr*ii

print(cc)
print(dd)
</code></pre>
<p>$rr$和$mm$都是{0，1}数组,$cc&#x3D;rr\oplus mm$</p>
<p>$ii$是你输入的一维数组，输出$rr*ii$</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>很容易把这个联系到backpack问题，还是让我们构造backpack。</p>
<p>那我们可以构造很特殊的backpack</p>
<p>$ii&#x3D;[1,2,4,8,…..]$</p>
<p>那么就有$rr$了，有$rr$之后$mm$也就出来了。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">from pwn import *

s = 0
a = []
# 这儿是将思路中构造的数组reverse了，本质一样
# 这样后续操作简单一点
for i in range(256):
    a.append(1 &lt;&lt; (255 - i))
o = &quot;,&quot;.join(map(str, a))

IP, PORT = &quot;manqiu.top 20765&quot;.split()
conn = remote(IP, PORT)
print(conn.recvuntil(b&quot;r left for you: &quot;))
conn.sendline(o.encode())
print(conn.recvline().decode())

for i in range(255):
    conn.recvline().decode()
print(conn.recvline().decode())
</code></pre>
<p>将输出的$cc$第一行，和与之对应$rr*ii$的第一个答案拿出来。其实哪一行都一样，对应好就行</p>
<pre><code class="python">from Crypto.Util.number import *

a = &quot;1 1 0 0 .....&quot;
a = a.replace(&quot; &quot;, &quot;&quot;)
a = int(a, 2)
m = ....

print(long_to_bytes(m ^ a))
</code></pre>
<h2 id="basiclog"><a href="#basiclog" class="headerlink" title="basiclog"></a>basiclog</h2><h3 id="题意-1"><a href="#题意-1" class="headerlink" title="题意"></a>题意</h3><pre><code class="python">q = 11769445852166501942131444325164359907623906505859865854871085543754710159882777389890225783970170353153967463136054852998337865848469266919651006863215539
p = 23538891704333003884262888650328719815247813011719731709742171087509420319765554779780451567940340706307934926272109705996675731696938533839302013726431079
g = 2
y = pow(g,pow(g,x,p),q)
print(y)
</code></pre>
<p>求 x </p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>也就是$2^{2^x\ mod\ p}&#x3D;y\ mol\ q$</p>
<p>首先注意$\phi(q) &#x3D; 2*p$</p>
<p>然后就猜测<strong>指数处对p取模不影响结果</strong>，多选取几个x发现确实成立。</p>
<p>于是虽然距离证明差简单一步，但这个结论我就直接拿来用了。</p>
<p>猜测此处需要平方处理</p>
<p>$$y^2 &#x3D; (2^{2^{x}})^2 &#x3D; 2^{2^{x}*2} &#x3D; 2^{2^{x+1}} $$</p>
<p>为方便叙述，我们设$y &#x3D; f(x)$, $x &#x3D; f^{-1}(y)$</p>
<p>由上面的式子我们就知道</p>
<p>$$f^{-1}(y) &#x3D; f^{-1}(y^2)-1$$</p>
<p>然后这是可以一直迭代下去的</p>
<p>$$f^{-1}(y) &#x3D; f^{-1}(y^2)-1&#x3D;f^{-1}(y^4)-2&#x3D;f^{-1}(y^8)-3&#x3D;….$$</p>
<p>一直写下去什么时候结束呢。我们可以先打弄一个字典dic来打表，当y的值出现在表中的时候就结束，然后就能得到x</p>
<p>$x$是48bit的，那我们可以先均匀打$2^{24}$个点，然后那么y就大约需要迭代$2^{24}$次就可以出答案</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">dic = &#123;&#125;

# 按照上面的思路应该是N1 = N2 = 2**24，但是实际
# 操作下来打表建立字典很慢，而其实迭代的过程相对
# 较快，于是就调整了N1，N2的大小，最后3min跑完。

N1 = 2**19 
N2 = 2**29
g1 = pow(g, N2, q)
print(q.bit_length())
print(p.bit_length())
for i in range(N1 - N1 // 1, N1):
    if i % (2**16) == 0:
        print(i)

    tmp1 = pow(g1, i, q)
    y = pow(g, tmp1, p)
    dic[y] = i * N2

def brute(y: int):
    for i in range(N2):
        if y in dic:
            x = dic[y] - i
            break
        y = (y * y) % p
    else:
        x = 0
        print(&quot;not found&quot;)
    print(x)

y =  ...

print(brute(y))
</code></pre>
<h2 id="sign-ahead"><a href="#sign-ahead" class="headerlink" title="sign_ahead"></a>sign_ahead</h2><h3 id="题意-2"><a href="#题意-2" class="headerlink" title="题意"></a>题意</h3><pre><code class="python">key = token_bytes(32)

msg = token_bytes(64)

sign = md5(key + msg).hexdigest()

print(&#39;msg:&#39;, msg.hex())
print(&#39;sign:&#39;, sign)

print(&#39;FORGE ME!!!!&#39;)
    
newmsg = bytes.fromhex(input(&#39;msg: &#39;))
newsign = input(&#39;sign: &#39;).strip()

assert msg != newmsg

if md5(key + newmsg).hexdigest() == newsign:
    print(&#39;GREAT JOB&#39;)
    successful_forge += 1
    
</code></pre>
<p>已知msg和md5(key+msg)，任意找一个newmsg和其对应的md5(key+newmsg)</p>
<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p><a target="_blank" rel="noopener" href="https://hackmd.io/@amyriad/hkcert-signin">Sign in Please</a></p>
<p>前不久做的某题的题解，看懂那题的思路就可以直接拿来套这题，那题当时的加密是sha256,本题是md5，但本质是一样的。</p>
<p>首先要去找md5的py实现<a target="_blank" rel="noopener" href="https://github.com/acmeism/RosettaCodeData/blob/ed705008a8d39177a7cc5a047705a2e3700b6c2b/Task/MD5-Implementation/Python/md5-implementation.py#L8">md5-implementation.py</a>，然后和那题一样稍微修改一下，修改其中的my_md5函数，增加pads&#x3D;False的选择和hash初始值的设置</p>
<pre><code class="python">def md5(message,pads = True,hash_pieces = None):
 
    message = bytearray(message) #copy our input into a mutable buffer
    orig_len_in_bits = (8 * len(message)) &amp; 0xffffffffffffffff
    if pads:
        message.append(0x80)
        while len(message)%64 != 56:
            message.append(0)
        message += orig_len_in_bits.to_bytes(8, byteorder=&#39;little&#39;)
    else:
        while len(message)%64 != 0:
            message.append(0)
    if hash_pieces == None:
        hash_pieces = init_values[:]
    ...
</code></pre>
<p>然后其实基本已经出了，细节见下文注释</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">

def to_hash_array(m:str)-&gt;list:
    arr = [bytes.fromhex(m[i:i+8]) for i in range(0,len(m),8)]
    return list(map(lambda x:int.from_bytes(x, byteorder=&#39;little&#39;),arr))

def attack_md5(msg:str,sign):
    key = b&#39;\0&#39;*32
    msg = bytes.fromhex(msg)
    hash = to_hash_array(sign)
    
    length1 = 96
    orig_len_in_bits = (8 * length1) &amp; 0xffffffffffffffff
    message = bytearray(key + msg)
    message.append(0x80)
    while len(message)%64 != 56:
        message.append(0)
    message += orig_len_in_bits.to_bytes(8, byteorder=&#39;little&#39;)
    new_msg = bytes(message)[32:]
    # key + new_msg其实就是key + msg经过pad的结果

    # key + new_msg仍然需要经过pad。他有三个chunk。
    # 前两个chunk和key+msg的chunk一样，所以经过前两
    # 轮循环的hash_pieces其实就是sign。所以我们只需
    # 要对第三个chunk进行一轮循环就行，这里我将第三轮
    # chunk的内容放在message中，然后走一轮不要循环就
    # 行了。
    length1 = 128
    orig_len_in_bits = (8 * length1) &amp; 0xffffffffffffffff
    message = bytearray(b&quot;&quot;)
    message.append(0x80)
    while len(message)%64 != 56:
        message.append(0)
    message += orig_len_in_bits.to_bytes(8, byteorder=&#39;little&#39;)
    # print(message)
    new_sign = md5_to_hex(md5(bytes(message),False,hash))
    return new_msg.hex(),new_sign

# 这个有个坑是pwn和我找的md5函数里面都定义了constants
# 变量，直接import * 会有问题
from pwn import remote
IP,PORT = &quot;manqiu.top:21072&quot;.split(&quot;:&quot;)
conn = remote(IP, PORT)
for i in range(100):
    conn.recvuntil(&quot;msg:&quot;)
    msg = conn.recvline().decode().strip()
    conn.recvuntil(&quot;sign:&quot;)
    sign = conn.recvline().decode().strip()
    new_msg,new_sign = attack_md5(msg,sign)
    conn.sendlineafter(&quot;msg: &quot;,new_msg.encode())
    conn.sendlineafter(&quot;sign: &quot;,new_sign.encode())
    print(conn.recvline())
print(conn.recvline())
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

      <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 shizuku&#39;s home
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;shizuku
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

    </div>
    
    <transition name="fade">
      <div id="preview" ref="preview" v-show="previewShow">
        <img id="preview-content" ref="previewContent" />
      </div>
    </transition>
    
  </div>
  <script src="/js/main.js"></script>
  
  




  
</body>

</html>