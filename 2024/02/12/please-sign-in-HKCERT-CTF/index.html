
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Sign_in_Please_HKCERT_CTF | shizuku&#39;s home</title>
    <meta name="author" content="shizuku" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link rel="icon" href="/images/setumi.jpg" />
    <link rel="preconnect" href="https://cdn.staticfile.org" />
<script src="https://cdn.staticfile.org/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.loli.net" />
<link rel="preconnect" href="https://gstatic.loli.net" crossorigin />
<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap" />
<script>
  const mixins = {};
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.org/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.org/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/11.9.0/styles/github.min.css" />
<script src="/js/lib/highlight.js"></script>


<script src="https://cdn.staticfile.org/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdn.staticfile.org/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />


<canvas id="fireworks" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"></canvas>
<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>
<script src="/js/lib/fireworks.min.js"></script>

<!--
<canvas id="background" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1"></canvas>
<script src="/js/lib/background.min.js"></script>
-->
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="shizuku's home" type="application/atom+xml">
</head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>SHIZUKU&#39;S HOME</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/friendLinks">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Friend Links</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;SHIZUKU&#39;S HOME</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
                <a href="/friendLinks">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-link fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Friend Links</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>Sign_in_Please_HKCERT_CTF</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/2/12
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/crypto/" style="color: #ffa2c4">crypto</a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <p>妄图尝试cryptohack网站的ctf题目，想要挑一道solve数最多的软柿子捏，结果发现根本没有软柿子。</p>
<p><a target="_blank" rel="noopener" href="https://cryptohack.org/challenges/ctf-archive/">Sign_in_Please</a> 网站最下面那道</p>
<span id="more"></span>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><pre><code class="python">def permutate(payload:bytes, pbox):
    return bytes([payload[x] for x in pbox])
</code></pre>
<pre><code class="python">
class Client:
    def __init__(self, password : bytes):
        self.password = password

    def spy(self, pbox, salt : bytes):
        assert len(set(pbox)) == 20
        assert len(salt) == 4
        password = self.password
        permutated_password = permutate(password + salt, pbox)

        hashed_password = hashlib.sha256(permutated_password).hexdigest()
        print(f&#39;[hash] &#123;hashed_password&#125;&#39;)
</code></pre>
<p><strong>spy</strong> 接收一个含有20个不同索引的<strong>pbox</strong>，和一个4byte的<strong>slat</strong>，把<strong>salt</strong>加入16byte的<strong>password</strong>后面之后按照<strong>pbox</strong>中的索引进行重排，预期<strong>pbox</strong>是[0,20)的一个重排</p>
<p><strong>auth</strong> 不好转空子，能不能绕过基本上就看能不能拿到通过<strong>spy</strong>拿到<strong>password</strong></p>
<h2 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h2><p>如果没有<strong>len(set(pbox)) &#x3D;&#x3D; 20</strong>的判断的话, 而只是一个简单的<strong>len(pbox) &#x3D;&#x3D; 20</strong>，我们可以让</p>
<pre><code class="python">salt = b&#39;aaaa&#39;
pbox = [19]*18 + [i, i + 1]
</code></pre>
<p>这样<strong>permutated_password</strong>就变成了<strong>b’a’*18</strong>+??，其中？是base64字符，有64种可能，那我们直接根据sha256的结果64*64的枚举就可以把<strong>password</strong>的 <strong>i</strong> 和<strong>i + 1</strong>处的索引值确定，那其实复原<strong>password</strong>就不难了。</p>
<p>可惜没有如果。</p>
<p>有一个比较好想的空子是预期的pbox是[0,20)的重排，<strong>pbox</strong>中的值大于20的确会报out of boundary的错，但他可以小于0啊，因为python支持负索引，所有我们可以spy可以每次只拿10个字符出来hash</p>
<pre><code class="python">salt = b&#39;aaaa&#39;
pbox = [16, 17, 18, 19] + [-4, -3, -2, -1]
pbox = pbox + [idx + i for i in range(6)]
pbox = pbox + [idx + i - 20 for i in range(6)]
</code></pre>
<p>通过这样子构造<strong>pbox</strong>，得到的<strong>permutated_password</strong>只有6个未知字符，我们当然可以尝试<strong>sha256</strong>直接枚举，但是我们这样就总共有$64^6&#x3D;2^{36}$种可能，而我们计算机枚举的上限一般在$2^{32}$左右，我们现在直接枚举行吗？如行，只要你有很多台性能很棒的计算机帮你算的话，你到这儿就已经差不多结束了。</p>
<p>但显然，我是没有那么好的计算机的。</p>
<p>我们现在先换个思路，假如<strong>spy</strong>的次数没有限制的话我们可以怎么做。那样子的话其实可以逐byte检验<strong>pbox</strong>的每个值</p>
<pre><code class="python">salt = b&quot;dcba&quot;
pbox1 = list(range(20))
pbox2 = [-1] + list(range(1, 20)) 
</code></pre>
<p>比较<strong>spy(pbox1, slat)<strong>和</strong>spy(pbox2, slat)<strong>否相等就可以判断</strong>password</strong>的第一位是不是a, 把-1改成-2, -3, -4，还能确定第一位是不是b,c,d。这样逐byte一个一个检查就可以线性时间确定<strong>password</strong>的值了</p>
<p>但<strong>spy最多</strong>只能由9次，能够确定<strong>password</strong>的一位都够呛</p>
<p>但只要我还知道一个<strong>password</strong>的字符的话，那我上面枚举的办法就只需要枚举$2^{30}$种情况了，那我还是能接受的。</p>
<p>我们可以先假设<strong>password</strong>的第一位是a,b,c,d种的一个，然后用最多5次<strong>spy</strong>把第一位找到。如果不在的话我们可以直接重新连接了。</p>
<pre><code class="python"># 猜测password中第一位字符
def guess_the_first_byte() -&gt; bytes:
    salt = b&quot;abcd&quot;
    pbox = list(range(20))
    # print(pbox)
    hash_password = spy(pbox, salt)
    for i in range(-4, 0):
        print(f&quot;now is guess &#123;bytes[salt[i]]&#125;&quot;)
        pbox = [i] + list(range(1, 20))
        if spy(pbox, salt) == hash_password:
            return bytes([salt[i]])
    return b&quot;&quot;
</code></pre>
<pre><code class="python">cnt = 0
while True:
    cnt += 1
    print(f&quot;第&#123;cnt&#125;次连接&quot;)
    conn = remote(IP, PORT)
    # print(&quot;conneted&quot;)
    first_byte = guess_the_first_byte()
    if first_byte == b&quot;&quot;:
        conn.close()
        print(&quot;failed to guess the first byte&quot;)
        continue
    print(f&quot;the first byte is &#123;first_byte&#125;.&quot;)
</code></pre>
<p>因为每一位有64种可能，我们连个16次大约就能出了，这还是可以接受的</p>
<p>知道<strong>password</strong>的第一位之后，我们可以按照上面的方法在大约10min左右的时间暴力枚举出<strong>password</strong>的2~6位。这儿又需要<strong>spy</strong>1次</p>
<pre><code class="python">def brute(idx: int, first_byte):
    salt = b&quot;aaaa&quot;
    pbox = [0, 16, 17, 18, 19] + [-20, -4, -3, -2, -1]
    pbox = pbox + [idx + i for i in range(5)]
    pbox = pbox + [idx + i - 20 for i in range(5)]
    hash_text = spy(pbox, salt)
    suffix = first_byte + salt
    print(hash_text)
    for a1 in charset:
        print(a1, end=&quot; &quot;)
        for a2 in charset:
            for a3 in charset:
                for a4 in charset:
                    for a5 in charset:
                        m = bytes([a1, a2, a3, a4, a5])
                        text = suffix * 2 + m * 2
                        if hashlib.sha256(text).hexdigest() == hash_text:
                            print()
                            return m
    print(&quot;No sollution found&quot;)
    return b&quot;&quot;
</code></pre>
<p>接下来我们可以继续5位5位地爆破，但5位效率还是太低了。因为我们现在又多知道了几位，所有我们现在可以四位四位爆破了，这儿需要<strong>spy</strong>3次。</p>
<p>知道<strong>password</strong>之后，我们就很容易一次<strong>auth</strong>出flag了。刚刚好$5 + 1 + 3 + 1 &#x3D; 10$次</p>
<p>下面是完整代码</p>
<pre><code class="python">from pwn import *
import base64
import hashlib

charset = b&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;

IP, PORT = &quot;archive.cryptohack.org 1024&quot;.split()


def spy(pbox: list, salt: bytes):
    conn.recvuntil(b&quot;[cmd] &quot;)
    conn.sendline(b&quot;spy&quot;)

    conn.recvuntil(b&quot;[pbox] &quot;)
    conn.sendline(str(pbox).encode())

    conn.recvuntil(b&quot;[salt] &quot;)
    conn.sendline(base64.b64encode(salt))

    conn.recvuntil(b&quot;[hash] &quot;)
    recv_text = conn.recvline()
    return recv_text.strip().decode()


def permutate(payload: bytes, pbox):
    return bytes([payload[x] for x in pbox])


def auth(password: bytes):
    conn.recvuntil(b&quot;[cmd] &quot;)
    conn.sendline(b&quot;auth&quot;)

    conn.recvuntil(b&quot;[pbox] &quot;)
    pbox = eval(conn.recvline().strip().decode())

    conn.recvuntil(b&quot;[salt] &quot;)
    salt = base64.b64decode(conn.recvline().strip())

    conn.recvuntil(b&quot;[hash] &quot;)
    permutated_password = permutate(password + salt, pbox)
    conn.sendline(hashlib.sha256(permutated_password).hexdigest().encode())

    return conn.recvline().strip()


# 爆破idx往后五位字符需要知道第一个字符
def brute(idx: int, first_byte):
    salt = b&quot;aaaa&quot;
    pbox = [0, 16, 17, 18, 19] + [-20, -4, -3, -2, -1]
    pbox = pbox + [idx + i for i in range(5)]
    pbox = pbox + [idx + i - 20 for i in range(5)]
    hash_text = spy(pbox, salt)
    suffix = first_byte + salt
    print(hash_text)
    for a1 in charset:
        print(a1, end=&quot; &quot;)
        for a2 in charset:
            for a3 in charset:
                for a4 in charset:
                    for a5 in charset:
                        m = bytes([a1, a2, a3, a4, a5])
                        text = suffix * 2 + m * 2
                        if hashlib.sha256(text).hexdigest() == hash_text:
                            print()
                            return m
    print(&quot;No sollution found&quot;)
    return b&quot;&quot;


def brute_four_bytes(idx: int, b1, b2):
    salt = b&quot;aaaa&quot;
    pbox = [0, 1, 16, 17, 18, 19] + [-20, -19, -4, -3, -2, -1]
    pbox = pbox + [idx + i for i in range(4)]
    pbox = pbox + [idx + i - 20 for i in range(4)]
    hash_text = spy(pbox, salt)
    suffix = b1 + b2 + salt
    print(hash_text)
    for a1 in charset:
        for a2 in charset:
            for a3 in charset:
                for a4 in charset:
                    m = bytes([a1, a2, a3, a4])
                    text = suffix * 2 + m * 2
                    if hashlib.sha256(text).hexdigest() == hash_text:
                        return m
    print(&quot;No sollution found&quot;)
    return b&quot;&quot;


# 猜测password中第一位字符
def guess_the_first_byte() -&gt; bytes:
    salt = b&quot;abcd&quot;
    pbox = list(range(20))
    # print(pbox)
    hash_password = spy(pbox, salt)
    for i in range(-4, 0):
        print(f&quot;now is guess &#123;bytes[salt[i]]&#125;&quot;)
        pbox = [i] + list(range(1, 20))
        if spy(pbox, salt) == hash_password:
            return bytes([salt[i]])
    return b&quot;&quot;


cnt = 0
while True:
    cnt += 1
    print(f&quot;第&#123;cnt&#125;次连接&quot;)
    conn = remote(IP, PORT)
    # print(&quot;conneted&quot;)
    first_byte = guess_the_first_byte()
    if first_byte == b&quot;&quot;:
        conn.close()
        print(&quot;failed to guess the first byte&quot;)
        continue
    print(f&quot;the first byte is &#123;first_byte&#125;.&quot;)

    password = first_byte
    password += brute(1, first_byte)[:3]
    print(f&quot;the prefix of password is &#123;password&#125;&quot;)
    for i in range(4, 13, 4):
        password += brute_four_bytes(i, first_byte, bytes([password[1]]))
    print(password)

    print(auth(password))
    break
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 shizuku&#39;s home
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;shizuku
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>